
## ðŸ› ï¸ ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹ CPU Ð´Ð»Ñ Zabbix 7.4+ (One-Liner Edition)

Ð­Ñ‚Ð¾ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñƒ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ ÑÐ´Ñ€Ð° Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ñ€Ð°, Ð° Ñ‚Ð°ÐºÐ¶Ðµ ÑÑ€ÐµÐ´Ð½ÑŽÑŽ, Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð¸ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñƒ.
Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ `UserParameter` Ñ awk-Ð¿Ð°Ñ€ÑÐµÑ€Ð¾Ð¼, Ð¼Ð¸Ð½Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÑ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð²Ð½ÐµÑˆÐ½Ð¸Ñ… ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð².

**ÐÐ²Ñ‚Ð¾Ñ€ Ð¸Ð´ÐµÐ¸:** [B1T0 Tobias Scheithauer ](https://github.com/B1T0/zabbix-basic-cpu-temperature?tab=readme-ov-file)
**ÐÐ´Ð°Ð¿Ñ‚Ð°Ñ†Ð¸Ñ:** *[didimozg]*

### Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° (lm-sensors)

Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð¿Ð°ÐºÐµÑ‚ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ ÑÐµÐ½ÑÐ¾Ñ€Ð°Ð¼Ð¸:

```bash
sudo apt update
sudo apt install lm-sensors gawk -y
sudo sensors-detect  # ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹Ñ‚Ðµ YES Ð½Ð° Ð²ÑÐµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹

```

### Ð¨Ð°Ð³ 2: Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¸Ñ ÑÐ´ÐµÑ€ (Discovery)

Ð¢Ð°Ðº ÐºÐ°Ðº Zabbix Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ JSON Ð´Ð»Ñ LLD (Low Level Discovery), Ð½Ð°Ð¼ Ð¿Ð¾Ð½Ð°Ð´Ð¾Ð±Ð¸Ñ‚ÑÑ Ð¾Ð´Ð¸Ð½ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ‚Ð¾Ð³Ð¾, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ð¹Ñ‚Ð¸ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐ´ÐµÑ€.

1. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»:
```bash
sudo nano /etc/zabbix/zabbix_agent2.d/get_cores.sh

```


2. Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ¾Ð´ (Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ JSON ÑÐ¾ ÑÐ¿Ð¸ÑÐºÐ¾Ð¼ ÑÐ´ÐµÑ€):
```bash
#!/bin/bash
# Ð’Ñ‹Ð²Ð¾Ð´ JSON ÑÐ¿Ð¸ÑÐºÐ° ÑÐ´ÐµÑ€ Ð´Ð»Ñ Zabbix LLD
first=1
echo "{\"data\":["
sensors | grep "^Core" | while read -r line; do
    # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð½Ð¾Ð¼ÐµÑ€ ÑÐ´Ñ€Ð° (Core 0, Core 1...)
    core_id=$(echo "$line" | awk '{print $2}' | tr -d ':')

    if [ "$first" -eq 0 ]; then echo ","; fi
    echo -n "{\"{#CORE}\":\"$core_id\"}"
    first=0
done
echo "]}"

```


3. Ð”Ð°Ð¹Ñ‚Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ:
```bash
sudo chmod +x /etc/zabbix/zabbix_agent2.d/get_cores.sh

```



### Ð¨Ð°Ð³ 3: ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Zabbix Agent

Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¼Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð²Ð°ÑˆÐ¸ awk-Ð¾Ð´Ð½Ð¾ÑÑ‚Ñ€Ð¾Ñ‡Ð½Ð¸ÐºÐ¸).

1. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°:
```bash
sudo nano /etc/zabbix/zabbix_agent2.d/userparameter_cputemp.conf

```


2. Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ñ‚ÑƒÐ´Ð° ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ:

```ini
# --- CPU Temperature Monitoring Parameters ---

# Discovery script location
UserParameter=basicCPUTemp.discovery,/etc/zabbix/zabbix_agent2.d/get_cores.sh

# Min core temp (Â°C) - Iterates all cores to find min
UserParameter=basicCPUTemp.min,LC_ALL=C sensors 2>/dev/null | awk '/^Core [0-9]+:/ { s=$0; sub(/^.*: */, "", s); if (match(s, /[-+]?[0-9]+(\.[0-9]+)?/)) { t=substr(s,RSTART,RLENGTH)+0; if (c==0||t<min) min=t; c++ } } END{ if (c>0) printf("%.1f", min); else print "-1" }'

# Max core temp (Â°C) - Iterates all cores to find max
UserParameter=basicCPUTemp.max,LC_ALL=C sensors 2>/dev/null | awk '/^Core [0-9]+:/ { s=$0; sub(/^.*: */, "", s); if (match(s, /[-+]?[0-9]+(\.[0-9]+)?/)) { t=substr(s,RSTART,RLENGTH)+0; if (c==0||t>max) max=t; c++ } } END{ if (c>0) printf("%.1f", max); else print "-1" }'

# Avg core temp (Â°C) - Calculates average across all cores
UserParameter=basicCPUTemp.avg,LC_ALL=C sensors 2>/dev/null | awk '/^Core [0-9]+:/ { s=$0; sub(/^.*: */, "", s); if (match(s, /[-+]?[0-9]+(\.[0-9]+)?/)) { sum+=substr(s,RSTART,RLENGTH)+0; c++ } } END{ if (c>0) printf("%.1f", sum/c); else print "-1" }'

# Specific core temp (Usage: basicCPUTemp.core[0], basicCPUTemp.core[1] ...)
# Note: $1 inside grep is the argument passed from Zabbix key (0, 1, etc)
UserParameter=basicCPUTemp.core[*],LC_ALL=C sensors 2>/dev/null | grep "^Core $1:" | awk '{print $3}' | sed 's/[^0-9.]//g'

```

3. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð°Ð³ÐµÐ½Ñ‚:
```bash
sudo systemctl restart zabbix-agent2

```



### Ð¨Ð°Ð³ 4: Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð° (YAML)

Ð­Ñ‚Ð¾Ñ‚ ÑˆÐ°Ð±Ð»Ð¾Ð½ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼ Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¾Ð¼ Ð²Ñ‹ÑˆÐµ. (Ð’Ð°Ð»Ð¸Ð´Ð½Ñ‹Ðµ UUIDv4, Zabbix 7.4).

Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ ÐºÐ°Ðº `template_cpu_temp_v7_final.yaml`.

```yaml
zabbix_export:
  version: '7.4'
  template_groups:
    - uuid: '7df96b18c230490a9a0a9e2307226338'
      name: Templates
  templates:
    - uuid: 'b9ff215cd8774e7780fc596eb582605b'
      template: 'Template basicCPUTemp'
      name: 'Template basicCPUTemp'
      description: |
        Template for monitoring CPU Temperature using lm-sensors.
        Uses optimized awk one-liners in agent config.
        
        Original idea: https://github.com/didimozg
        Updated for Zabbix 7.4 with UUIDv4 fixes.
      groups:
        - name: Templates
      items:
        - uuid: 'fec5da56886b40c48740a057d2be9c54'
          name: 'CPU Temperature Avg'
          key: basicCPUTemp.avg
          delay: 10s
          history: 90d
          value_type: FLOAT
          units: Â°C
          tags:
            - tag: Application
              value: Temperature
        - uuid: '627b89d7b1954d2ea649b23b8e83576a'
          name: 'CPU Temperature Max'
          key: basicCPUTemp.max
          delay: 10s
          history: 90d
          value_type: FLOAT
          units: Â°C
          tags:
            - tag: Application
              value: Temperature
          triggers:
            - uuid: 'f5075d392fd7436c8b89ae7cb74ab143'
              expression: 'last(/Template basicCPUTemp/basicCPUTemp.max)>90.0'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'avg(/Template basicCPUTemp/basicCPUTemp.max,60s)<75'
              name: 'Temperature high'
              priority: AVERAGE
            - uuid: '8347731ec5fb4fa3a1201fc0983b8cde'
              expression: 'last(/Template basicCPUTemp/basicCPUTemp.max)>95'
              recovery_mode: NONE
              name: 'Temperature too high'
              priority: DISASTER
              manual_close: 'YES'
        - uuid: '3b42e6a5c4c7418386961bb570d63b63'
          name: 'CPU Temperature Min'
          key: basicCPUTemp.min
          delay: 10s
          history: 90d
          value_type: FLOAT
          units: Â°C
          tags:
            - tag: Application
              value: Temperature
      discovery_rules:
        - uuid: 'aab958191be14454bbdecf00a6416b4d'
          name: 'CPU Cores Discovery'
          key: basicCPUTemp.discovery
          delay: 1h
          item_prototypes:
            - uuid: 'ab914fed6b4f477781dd24f4be9cf1b8'
              name: 'CPU Core {#CORE} Temp'
              key: 'basicCPUTemp.core[{#CORE}]'
              value_type: FLOAT
              units: Â°C
          trigger_prototypes:
            - uuid: '79a29e4682024220b224151475756303'
              expression: 'last(/Template basicCPUTemp/basicCPUTemp.core[{#CORE}])>85'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'avg(/Template basicCPUTemp/basicCPUTemp.core[{#CORE}],3m)<75'
              name: 'High temperature on Core {#CORE} (>85Â°C)'
              priority: HIGH
            - uuid: '81c6260196884849925e016147101867'
              expression: 'last(/Template basicCPUTemp/basicCPUTemp.core[{#CORE}])>95'
              name: 'Critical temperature on Core {#CORE} (>95Â°C)'
              priority: DISASTER
  graphs:
    - uuid: 'ff78a7a1ff9740198ff9c40fc3fce6ea'
      name: 'CPU Temperature'
      graph_items:
        - drawtype: BOLD_LINE
          color: 1A7C11
          calc_fnc: ALL
          item:
            host: 'Template basicCPUTemp'
            key: basicCPUTemp.min
        - sortorder: '1'
          drawtype: BOLD_LINE
          color: 2774A4
          calc_fnc: ALL
          item:
            host: 'Template basicCPUTemp'
            key: basicCPUTemp.avg
        - sortorder: '2'
          drawtype: BOLD_LINE
          color: F63100
          calc_fnc: ALL
          item:
            host: 'Template basicCPUTemp'
            key: basicCPUTemp.max

```
